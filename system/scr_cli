#!/bin/bash

SCRIPTS_DIR="/usr/local/LosChichos/scripts"

set +o notify
trap '' HUP

# Fuerza a que bash envíe cada línea sin buffer
export LC_ALL=C
export LANG=C
# Desactiva el buffer de stdout

perl -e 'select STDOUT; $| = 1;'



source /usr/local/LosChichos/system/auth.lib

# Authentication Loop
while true; do
  echo -n "Username: "
  read username
  echo -n "Password: "
  read password
  
  if [ "$username" == "SESSION_AUTH" ]; then
      if validate_session "$password"; then
          # Extract real username from session file
          # We know the token is valid, so the file exists
          SESSION_FILE="$SESSION_DIR/$password"
          REAL_USER=$(sed -n '1p' "$SESSION_FILE")
          echo "Login successful. Welcome $REAL_USER (via session)!"
          break
      else
          echo "Login failed. Invalid session."
      fi
  elif check_credentials "$username" "$password"; then
      echo "Login successful. Welcome $username!"
      break
  else
      echo "Login failed. Try again."
  fi
done

while true; do
  # Mostrar prompt i llegir entrada de l'usuari
  echo -n "LosChichos> "
  read input_line

  #Comprobar ?
case "$input_line" in
  "?")
    ls "$SCRIPTS_DIR"
    continue
    ;;
  "exit")
    break
    ;;
esac

  # Separar la línia en array d'arguments
  # Utilitzem 'read -a' per separar per espais
  read -a args <<< "$input_line"

  # Comprovar que s'ha introduït almenys un argument (nom del script)
  if [ ${#args[@]} -lt 1 ]; then
    continue
  fi

  SCRIPT_NAME="${args[0]}"
  SCRIPT_PATH="$SCRIPTS_DIR/$SCRIPT_NAME"

  # Arguments restants per passar al script
  SCRIPT_ARGS=("${args[@]:1}")

  # Comprovar que el script existeix i és executable
  if [ ! -x "$SCRIPT_PATH" ]; then
    echo "Error: El script '$SCRIPT_NAME' no existe o no es ejecutable a $SCRIPTS_DIR."
    continue
  fi

  # Executar el script amb els arguments
  "$SCRIPT_PATH" "${SCRIPT_ARGS[@]}"
done

