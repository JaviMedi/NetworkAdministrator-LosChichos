#!/bin/bash

###########################
## Script de Instalación ##
###########################

source /usr/local/LosChichos/conf/variables.conf



fnc_copia_ficheros()
{
	ORIGEN="../"
	DESTINO="/usr/local"
	NOMBRE_CARPETA=LosChichos
	DESTINO_FINAL="$DESTINO/$NOMBRE_CARPETA"

	echo "Copiando ficheros a $DESTINO_FINAL..."

	# Copiar carpeta
	cp -r "$ORIGEN" "$DESTINO_FINAL"

	# Asegurar propietario root:root
	chown -R root:www-data $DESTINO_FINAL

	echo "Ajustar permisos de $DESTINO_FINAL"
	chmod -R 750 $DESTINO_FINAL
}

fnc_configurar_https()
{

echo "Configurando HTTPS..."

DOMAIN="127.0.0.1"
SSL_CERT="/etc/ssl/certs/loschichos-selfsigned.crt"
SSL_KEY="/etc/ssl/private/loschichos-selfsigned.key"

# Activar módulos necesarios
a2enmod ssl
a2enmod headers
a2enmod rewrite
a2enmod cgi

# Generar certificado si no existe
if [ ! -f "$SSL_CERT" ]; then
    echo "Generando certificado SSL..."
    openssl req -x509 -nodes -days 365 \
        -newkey rsa:2048 \
        -keyout "$SSL_KEY" \
        -out "$SSL_CERT" \
        -subj "/CN=$DOMAIN"
fi

# Configurar HTTP → HTTPS
cat > /etc/apache2/sites-available/000-default.conf <<EOF
<VirtualHost *:80>
    ServerName $DOMAIN
    Redirect permanent / https://$DOMAIN/
</VirtualHost>
EOF

# Configurar VirtualHost HTTPS
cat > /etc/apache2/sites-available/loschichos-ssl.conf <<EOF
<VirtualHost *:443>
    ServerName $DOMAIN

    SSLEngine on
    SSLCertificateFile $SSL_CERT
    SSLCertificateKeyFile $SSL_KEY

    ScriptAlias /cgi-bin/ /usr/local/LosChichos/cgi-bin/

    RedirectMatch ^/$ /cgi-bin/main.cgi

    <Directory "/usr/local/LosChichos/cgi-bin">
        AllowOverride None
        Options +ExecCGI -MultiViews +SymLinksIfOwnerMatch
        Require all granted
        AddHandler cgi-script .cgi
    </Directory>

    # Cabeceras de seguridad
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
</VirtualHost>
EOF

a2ensite loschichos-ssl

systemctl reload apache2

echo "HTTPS configurado correctamente."
} 

################################################################################
### MAIN
################################################################################

SERVICE=loschichos.socket
SERVICE_UNIT=loschichos@.service
IP_ADDR="127.0.0.1"
PORT="1234"


if [[ "$EUID" -ne 0 ]]; then
	echo "Yeeeee, ejecuta esto como root anda..." >&2
	exit 1
fi


case "$1" in
  install | -y)
fnc_copia_ficheros
apt update
apt install -y curl
apt install -y net-tools

apt install -y apache2

fnc_configurar_https

## mierda de cgi

a2enmod cgi
cat > /etc/apache2/conf-available/loschichos-cgi.conf <<'EOF'
ScriptAlias /cgi-bin/ /usr/local/LosChichos/cgi-bin/

<Directory "/usr/local/LosChichos/cgi-bin">
    AllowOverride None
    Options +ExecCGI -MultiViews +SymLinksIfOwnerMatch
    Require all granted
    AddHandler cgi-script .cgi
</Directory>
EOF

a2enconf loschichos-cgi
systemctl restart apache2

## Esto debería funcionar, no se... 

a2dismod -f deflate
systemctl restart apache2

apt install -y expect
apt install -y socat
apt install -y iw
apt install -y dbus-x11
apt install -y aha

## Desactivar NetworkManager
echo "Desactivando NetworkManager.."

systemctl stop NetworkManager
systemctl disable NetworkManager
echo

echo "NetworkManager desactivado."

## EDITAR VISUDO PARA EL SCRIPT TALLAFOCS
USUARIO="www-data"
SUDO_FILE="/etc/sudoers.d/${USUARIO}-iptables"
REGLA="${USUARIO} ALL=(ALL) NOPASSWD: /usr/sbin/iptables"

if ! id "$USUARIO" &>/dev/null; then
    echo "El usuario $USUARIO no existe"
    exit 1
fi

echo "$REGLA" > "$SUDO_FILE"

chmod 440 "$SUDO_FILE"

if visudo -cf "$SUDO_FILE"; then
    echo "Regla sudoers válida"
    echo "$USUARIO puede usar iptables sin contraseña"
else
    echo "ERROR en sintaxis sudoers, no se aplica"
    rm -f "$SUDO_FILE"
    exit 1
fi

    echo "Instalando servicio LosChichos..."

    cat > /etc/systemd/system/loschichos.socket <<EOF
[Unit]
Description=LosChichos TCP socket

[Socket]
ListenStream=${IP_ADDR}:${PORT}
Accept=yes
MaxConnections=20

[Install]
WantedBy=sockets.target
EOF

    cat > /etc/systemd/system/loschichos@.service <<EOF
[Unit]
Description=LosChichos session

[Service]
ExecStart=${DIR}/${PROJECTO}/${DIR_SYSTEM}/scr_cli
StandardInput=socket
StandardOutput=socket
StandardError=socket
KillMode=process
TimeoutStopSec=5
EOF

    systemctl daemon-reexec
    systemctl daemon-reload
    systemctl enable --now loschichos.socket

    echo "Servicio instalado y escuchando en $IP_ADDR:$PORT"
    ;;

  start)
    systemctl start $SERVICE
    ;;

  stop)
    systemctl stop $SERVICE
    ;;

  restart)
    systemctl restart $SERVICE
    ;;
  installhttps)
    fnc_configurar_https
    ;;

  status)
    systemctl status $SERVICE
    ;;
  uninstall)
    echo "Desinstalando servicio LosChichos..."

    systemctl disable --now $SERVICE
    rm -f /etc/systemd/system/loschichos.socket
    rm -f /etc/systemd/system/loschichos@.service

    systemctl daemon-reexec
    systemctl daemon-reload

    echo "Servicio desinstalado."
    ;;

  *)
    echo "Uso: install {install|uninstall|start|stop|restart|status|installhttps}"
    ;;
esac

#Esto debería funcionar, es un lio de código, lo he ido haciendo mientras añadía funciones.
#Lo he probado en un Ubuntu 24.04.3 LTS, si usas otra distro, asegurate de que haya instalado las dependencias correctamente y debería funcionar.
#(Anotación futura, hacer un comprobador de que se halla instalado todo bien. Y quizás reacer todo el instalador, casi que será mas facil)